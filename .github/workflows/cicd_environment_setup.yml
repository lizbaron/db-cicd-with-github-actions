# This is the workflow to setup the environment for Data Platform CI/CD pipelines

name: CI/CD Environment Setup

on:
  workflow_dispatch: 
    inputs:
      projectName:
        description: 'Project Name'     
        required: true
        default: 'db-cicd-with-github-actions'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    name: Setup Azure Environment
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: input value test
        run: pwsh "$projectName = '${{ github.event.inputs.logLevel }}'; $projectName"

      # documentation: https://github.com/azure/login#configure-azure-credentials
      # next steps is to set up a service principal in azure which has permission to set up its own resource group and resources within that resource group, but not mess with those that it has not set up.
      - name: login via az module
        uses: azure/login@v1
        with:
          creds: ${{secrets.az_sp_credentials}}
          enable-azpssession: true 

      # documentation: https://github.com/marketplace/actions/azure-powershell-action
      - name: run azure powershell script
        uses: azure/powershell@v1
        with:
          azpsversion: '3.1.0'
          inlinescript: |
            $parameters = @{
              projectname = "xx${{ github.event.inputs.loglevel }}";
            }; 
            ./envsetup/setup.ps1 @parameters; 

